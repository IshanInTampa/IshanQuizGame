<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Travel Challenge ‚Äî 1960s‚Äì1970s</title>
  <style>
    :root{
      --bg: #0b1220;
      --surface: rgba(255,255,255,0.06);
      --surface2: rgba(255,255,255,0.10);
      --card: rgba(255,255,255,0.08);
      --text: #f4f6fb;
      --muted: rgba(244,246,251,0.72);
      --border: rgba(255,255,255,0.14);
      --shadow: 0 18px 40px rgba(0,0,0,0.35);
      --accent: #60a5fa;
      --good: #34d399;
      --bad: #fb7185;
      --warn: #fbbf24;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,0.25), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(52,211,153,0.18), transparent 60%),
        radial-gradient(900px 700px at 40% 90%, rgba(251,113,133,0.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height: 100vh;
    }

    .app{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px;
    }

    .header{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 18px;
      padding: 16px 18px;
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }

    .header::after{
      content:"";
      position:absolute;
      inset:-120px -200px auto auto;
      width: 360px;
      height: 360px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,0.35), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap:12px;
      flex-wrap: wrap;
    }

    .title{
      margin:0;
      font-size: 26px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .subtitle{
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
      max-width: 860px;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      color: var(--muted);
      backdrop-filter: blur(10px);
    }

    .chip strong{color: var(--text); font-weight: 800;}

    .main{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 14px;
      align-items:start;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 18px;
      padding: 18px;
      overflow: hidden;
    }

    .start{
      text-align:left;
      padding: 18px 10px 6px 10px;
    }

    .start h2{
      margin: 0 0 10px 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .copy{
      color: var(--muted);
      line-height: 1.55;
      margin: 0 0 14px 0;
      font-size: 14px;
    }

    .callout{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 12px 12px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
      margin: 12px 0 14px 0;
    }

    .callout strong{color: var(--text);}

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .btn{
      border: 1px solid var(--border);
      background: #0f172a;
      color: white;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.22);
      transition: transform 0.06s ease, background 0.15s ease, border-color 0.15s ease;
    }
    .btn:hover{ background:#111c35; border-color: rgba(255,255,255,0.22); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,0.06);
      color: var(--text);
    }
    .btn.secondary:hover{ background: rgba(255,255,255,0.10); }

    .statusGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
      margin-bottom: 12px;
    }

    .stat{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px 10px;
      min-height: 60px;
    }

    .stat .k{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    .stat .v{
      font-weight: 900;
      font-size: 18px;
    }

    .progressWrap{
      margin: 10px 0 14px 0;
    }
    .progressLabel{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(96,165,250,0.95), rgba(52,211,153,0.95));
      border-radius: 999px;
      transition: width 0.25s ease;
    }

    .qline{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin: 6px 0 8px 0;
    }

    .qline h3{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-size: 13px;
      background: rgba(255,255,255,0.06);
    }

    .question{
      font-size: 18px;
      margin: 12px 0 14px 0;
      line-height: 1.45;
      font-weight: 750;
    }

    .options{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }

    .opt{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 12px 12px;
      cursor: pointer;
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      box-shadow: 0 10px 18px rgba(0,0,0,0.20);
      user-select:none;
      transition: transform 0.06s ease, background 0.15s ease, border-color 0.15s ease;
    }
    .opt:hover{ background: rgba(255,255,255,0.10); }
    .opt:active{ transform: translateY(1px); }

    .opt.selected{
      outline: 3px solid rgba(96,165,250,0.55);
      border-color: rgba(96,165,250,0.85);
      background: rgba(96,165,250,0.18);
    }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .submitRow{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .submitRow .btn{
      padding: 12px 16px;
    }
    .kbd{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 6px 10px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Sidebar (NPC + instructions) */
    .npcPanel{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 12px;
    }

    .npcTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
    }

    .npcLabel{
      font-weight: 900;
      letter-spacing: 0.4px;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
    }

    canvas#npcCanvas{
      width: 100%;
      height: auto;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }

    .howto{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .howto b{color: var(--text);}

    .saveNote{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      opacity: 0.9;
    }

    .toast{
      position: fixed;
      inset: auto 18px 18px auto;
      background: rgba(15,23,42,0.95);
      color: white;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.40);
      max-width: 340px;
      display: none;
      z-index: 999;
      white-space: pre-line;
      font-size: 14px;
      line-height: 1.35;
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
    }

    /* Confetti overlay */
    #fxCanvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 998;
    }

    @media (max-width: 980px){
      .statusGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    @media (max-width: 820px){
      .main{ grid-template-columns: 1fr; }
      .npcPanel{ position: relative; top: auto; }
      .statusGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
  </style>
</head>

<body>
  <canvas id="fxCanvas"></canvas>

  <div class="app">
    <div class="header">
      <div class="titleRow">
        <div>
          <h1 class="title">Time Travel Challenge ‚Äî 1960s‚Äì1970s</h1>
          <p class="subtitle">
            This game ‚Äúconnects to the decade‚Äù because every question is pulled from major <b>1960s‚Äì1970s</b>
            pop culture and technology milestones ‚Äî like Beatlemania, Woodstock, Apollo 11, ARPANET, and early microprocessors.
            You‚Äôre traveling through that era and proving you know the events that shaped modern music, media, and computing.
          </p>
        </div>
      </div>

      <div class="chips">
        <div class="chip"><strong>2 Levels</strong> (Pop Culture, Tech)</div>
        <div class="chip"><strong>20 Questions</strong></div>
        <div class="chip"><strong>Progress Saved</strong> (auto)</div>
        <div class="chip"><strong>Three-Strikes = Recovery</strong> (no full restart)</div>
      </div>
    </div>

    <div class="main">
      <div class="panel" id="leftPanel"></div>

      <div class="npcPanel">
        <div class="npcTop">
          <div class="npcLabel">Anonymous NPC</div>
          <div class="pill" id="stabilityPill">Time Stability: ‚óè‚óè‚óè</div>
        </div>

        <canvas id="npcCanvas" width="260" height="360" aria-label="NPC"></canvas>

        <div class="howto">
          <b>How to play</b><br>
          1) Tap an answer choice.<br>
          2) Click the NPC <b>SUBMIT</b> sign <i>or</i> press the <b>Submit</b> button.<br>
          3) Correct = points + celebration üéâ<br>
          Wrong = stability drops. At 0, you go to a <b>Recovery</b> screen and keep your progress.
        </div>

        <div class="saveNote">
          Tip: Your progress is saved in this browser (so refreshing won‚Äôt erase it).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // -----------------------------
  // DATA
  // -----------------------------
  const QUESTIONS = {
    1: {year:"1964", question:"Which band helped spark 'Beatlemania' in the U.S. after appearing on The Ed Sullivan Show?",
        options:["The Beatles","The Rolling Stones","The Kinks"], answer:"The Beatles",
        fact:"The Beatles' 1964 Ed Sullivan appearance became a major pop culture moment."},
    2: {year:"1969", question:"Which music festival became a symbol of 1960s youth culture and peace?",
        options:["Woodstock","Altamont","Monterey Pop Festival"], answer:"Woodstock",
        fact:"Woodstock (1969) is one of the most iconic music festivals ever."},
    3: {year:"1969", question:"Which guitarist performed an iconic U.S. national anthem at Woodstock?",
        options:["Jimi Hendrix","Eric Clapton","Carlos Santana"], answer:"Jimi Hendrix",
        fact:"Hendrix‚Äôs Woodstock performance is legendary."},
    4: {year:"1961", question:"Which dance became a major craze in the early 1960s?",
        options:["The Twist","Disco","Breakdancing"], answer:"The Twist",
        fact:"The Twist became hugely popular in the early 1960s."},
    5: {year:"1960", question:"Which animated family lived in the Stone Age?",
        options:["The Flintstones","The Jetsons","Scooby-Doo"], answer:"The Flintstones",
        fact:"The Flintstones was one of TV‚Äôs first animated sitcoms."},
    6: {year:"1966", question:"Which made-for-TV band became a real hit group?",
        options:["The Monkees","The Beach Boys","The Doors"], answer:"The Monkees",
        fact:"The Monkees starred in a TV show and topped music charts."},
    7: {year:"1968", question:"Which Beatles song was written as encouragement?",
        options:["Hey Jude","Good Vibrations","Light My Fire"], answer:"Hey Jude",
        fact:"Hey Jude became one of the Beatles‚Äô biggest hits."},
    8: {year:"1964", question:"Which boxer later became Muhammad Ali?",
        options:["Cassius Clay","Joe Frazier","George Foreman"], answer:"Cassius Clay",
        fact:"Cassius Clay changed his name to Muhammad Ali."},
    9: {year:"1960s", question:"Which fashion item became popular in the late 1960s?",
        options:["Bell-bottom jeans","Top hats","Powdered wigs"], answer:"Bell-bottom jeans",
        fact:"Bell-bottoms became a defining fashion trend."},
    10:{year:"1970s", question:"Which music genre dominated youth culture in the 1970s?",
        options:["Rock","Hip-hop","EDM"], answer:"Rock",
        fact:"Rock music expanded into many subgenres."},

    11:{year:"1961", question:"Which technology enabled human spaceflight?",
        options:["Rocket propulsion","Jet skis","Steam engines"], answer:"Rocket propulsion",
        fact:"Rocket propulsion made space travel possible."},
    12:{year:"1969", question:"Which mission landed humans on the Moon?",
        options:["Apollo 11","Apollo 8","Apollo 13"], answer:"Apollo 11",
        fact:"Apollo 11 landed astronauts on the Moon in 1969."},
    13:{year:"1969", question:"Which network became the foundation of the internet?",
        options:["ARPANET","World Wide Web","Bluetooth"], answer:"ARPANET",
        fact:"ARPANET connected early computers."},
    14:{year:"1960s", question:"Which invention replaced vacuum tubes?",
        options:["Transistors","Typewriters","Candles"], answer:"Transistors",
        fact:"Transistors made computers smaller and faster."},
    15:{year:"1968", question:"Who demonstrated the first computer mouse?",
        options:["Douglas Engelbart","Thomas Edison","Henry Ford"], answer:"Douglas Engelbart",
        fact:"Engelbart demonstrated the mouse in 1968."},
    16:{year:"1962", question:"Which aircraft photographed missile sites in Cuba?",
        options:["U-2 spy plane","Hot-air balloon","Submarine camera"], answer:"U-2 spy plane",
        fact:"U-2 planes gathered critical intelligence."},
    17:{year:"1960s", question:"Which technology enabled global communication?",
        options:["Communication satellites","Smoke signals","Wagons"], answer:"Communication satellites",
        fact:"Satellites enabled worldwide communication."},
    18:{year:"1960s", question:"Which machine enabled open-heart surgery?",
        options:["Heart-lung machine","Thermometer","Stethoscope"], answer:"Heart-lung machine",
        fact:"It circulates blood during surgery."},
    19:{year:"1971", question:"Which was the first widely used microprocessor?",
        options:["Intel 4004","CD player","GPS receiver"], answer:"Intel 4004",
        fact:"The Intel 4004 began the microprocessor era."},
    20:{year:"1969", question:"Why was the Moon landing a technological milestone?",
        options:["Advanced engineering and computing","Cars could fly","Video games became popular"],
        answer:"Advanced engineering and computing",
        fact:"It required breakthroughs in engineering and computing."}
  };

  const TOTAL_QUESTIONS = Object.keys(QUESTIONS).length;
  const POINTS_PER_CORRECT = 5;

  // -----------------------------
  // PROGRESS / GAMEPLAY IMPROVEMENT
  // Instead of restarting after 3 strikes:
  // - You have "Time Stability" (3).
  // - When it hits 0, you enter a Recovery screen (progress is kept).
  // - Recovery gives a quick summary + lets you continue from the SAME question
  //   with stability reset, but with a small score penalty (progress tracking).
  // -----------------------------
  const MAX_STABILITY = 3;
  const RECOVERY_PENALTY = 5; // points deducted on recovery (min 0)

  // -----------------------------
  // STATE (saved)
  // -----------------------------
  const STORAGE_KEY = "time_travel_challenge_v2";

  let qnum = 1;
  let score = 0;
  let stability = MAX_STABILITY;

  let correctCount = 0;
  let wrongCount = 0;
  let streak = 0;
  let bestStreak = 0;

  let selectedOption = null;
  let submitEnabled = false;

  // Track misses for a more meaningful end screen (data tracking)
  let misses = {}; // {qnum: {picked, answer}}

  // NPC mood: "neutral" | "happy" | "sad"
  let npcMood = "neutral";

  // -----------------------------
  // ELEMENTS
  // -----------------------------
  const leftPanel = document.getElementById("leftPanel");
  const toast = document.getElementById("toast");
  const npcCanvas = document.getElementById("npcCanvas");
  const ctx = npcCanvas.getContext("2d");

  const stabilityPill = document.getElementById("stabilityPill");

  // Confetti canvas
  const fxCanvas = document.getElementById("fxCanvas");
  const fx = fxCanvas.getContext("2d");
  let confettiParticles = [];
  let fxRAF = null;

  function resizeFX(){
    fxCanvas.width = window.innerWidth;
    fxCanvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeFX);
  resizeFX();

  // -----------------------------
  // SOUND (no external files)
  // WebAudio tone beeps for happy/sad.
  // -----------------------------
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }

  function playTone({freq=440, duration=0.12, type="sine", gain=0.07, ramp=0.02}){
    try{
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;

      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(gain, audioCtx.currentTime + ramp);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);

      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + duration + 0.02);
    }catch(e){}
  }

  function playHappySound(){
    // quick uplifting arpeggio
    playTone({freq: 523.25, duration: 0.09, type:"triangle", gain:0.08});
    setTimeout(()=>playTone({freq: 659.25, duration: 0.09, type:"triangle", gain:0.08}), 80);
    setTimeout(()=>playTone({freq: 783.99, duration: 0.11, type:"triangle", gain:0.09}), 160);
  }

  function playSadSound(){
    // descending tones
    playTone({freq: 392.00, duration: 0.10, type:"sine", gain:0.08});
    setTimeout(()=>playTone({freq: 329.63, duration: 0.12, type:"sine", gain:0.08}), 110);
    setTimeout(()=>playTone({freq: 261.63, duration: 0.14, type:"sine", gain:0.08}), 230);
  }

  // -----------------------------
  // UTIL
  // -----------------------------
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function showToast(title, body) {
    toast.style.display = "block";
    toast.textContent = `${title}\n\n${body}`;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => (toast.style.display = "none"), 2800);
  }

  function levelForQuestion(n) {
    return n <= 10 ? 1 : 2;
  }

  function accuracy(){
    const total = correctCount + wrongCount;
    return total === 0 ? 0 : Math.round((correctCount / total) * 100);
  }

  function stabilityDots(){
    const filled = "‚óè".repeat(stability);
    const empty = "‚óã".repeat(MAX_STABILITY - stability);
    return filled + empty;
  }

  function updateStabilityPill(){
    stabilityPill.textContent = `Time Stability: ${stabilityDots()}`;
    stabilityPill.style.borderColor =
      stability === MAX_STABILITY ? "rgba(52,211,153,0.5)" :
      stability === 2 ? "rgba(251,191,36,0.5)" :
      "rgba(251,113,133,0.55)";
  }

  // -----------------------------
  // SAVE / LOAD
  // -----------------------------
  function saveState(){
    const payload = {
      qnum, score, stability,
      correctCount, wrongCount, streak, bestStreak,
      misses
    };
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
  }

  function clearSave(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      const s = JSON.parse(raw);

      // Basic validation / defaults
      qnum = clamp(Number(s.qnum || 1), 1, TOTAL_QUESTIONS);
      score = Math.max(0, Number(s.score || 0));
      stability = clamp(Number(s.stability || MAX_STABILITY), 0, MAX_STABILITY);

      correctCount = Math.max(0, Number(s.correctCount || 0));
      wrongCount = Math.max(0, Number(s.wrongCount || 0));
      streak = Math.max(0, Number(s.streak || 0));
      bestStreak = Math.max(0, Number(s.bestStreak || 0));

      misses = s.misses && typeof s.misses === "object" ? s.misses : {};

      return true;
    }catch(e){
      return false;
    }
  }

  // -----------------------------
  // CONFETTI
  // -----------------------------
  function spawnConfetti(){
    const count = 160;
    const w = fxCanvas.width, h = fxCanvas.height;
    const originX = w * 0.5;
    const originY = h * 0.18;

    for (let i=0;i<count;i++){
      confettiParticles.push({
        x: originX,
        y: originY,
        vx: (Math.random()-0.5) * 9,
        vy: Math.random() * -9 - 4,
        g: 0.22 + Math.random()*0.10,
        r: 3 + Math.random()*4,
        a: 1,
        spin: (Math.random()-0.5) * 0.25,
        rot: Math.random()*Math.PI*2,
        life: 60 + Math.floor(Math.random()*35)
      });
    }
    if (!fxRAF) fxLoop();
  }

  function fxLoop(){
    fxRAF = requestAnimationFrame(fxLoop);
    fx.clearRect(0,0,fxCanvas.width, fxCanvas.height);

    for (let i=confettiParticles.length-1; i>=0; i--){
      const p = confettiParticles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.rot += p.spin;
      p.life -= 1;
      p.a = Math.max(0, p.life / 80);

      fx.save();
      fx.globalAlpha = p.a;
      fx.translate(p.x, p.y);
      fx.rotate(p.rot);

      // Intentionally not setting a fixed "theme"; random colors
      const hue = Math.floor(Math.random()*360);
      fx.fillStyle = `hsl(${hue} 90% 60%)`;
      fx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.0);

      fx.restore();

      if (p.life <= 0 || p.y > fxCanvas.height + 30){
        confettiParticles.splice(i,1);
      }
    }

    if (confettiParticles.length === 0){
      cancelAnimationFrame(fxRAF);
      fxRAF = null;
    }
  }

  // -----------------------------
  // NPC DRAW (now reacts: happy/sad face)
  // -----------------------------
  function drawNPC() {
    ctx.clearRect(0, 0, npcCanvas.width, npcCanvas.height);

    // background wash
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.03)";
    ctx.fillRect(0, 0, npcCanvas.width, npcCanvas.height);
    ctx.restore();

    // define colors based on mood
    const skin = "#f2d2a9";
    const shirt = npcMood === "sad" ? "#2b2f3a" : "#3b3f4a";
    const faceTint = npcMood === "happy" ? "rgba(52,211,153,0.18)" :
                     npcMood === "sad" ? "rgba(251,113,133,0.18)" : "rgba(96,165,250,0.10)";

    // mood aura
    ctx.save();
    ctx.fillStyle = faceTint;
    ctx.beginPath();
    ctx.ellipse(130, 75, 110, 95, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // head
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.fillStyle = skin;
    ctx.beginPath();
    ctx.ellipse(130, 65, 38, 38, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();

    // eyes
    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.beginPath(); ctx.arc(118, 63, 3.2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(142, 63, 3.2, 0, Math.PI*2); ctx.fill();

    // eyebrows (sad)
    ctx.strokeStyle = "rgba(0,0,0,0.60)";
    ctx.lineWidth = 2;
    if (npcMood === "sad"){
      ctx.beginPath(); ctx.moveTo(112, 56); ctx.lineTo(122, 52); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(148, 56); ctx.lineTo(138, 52); ctx.stroke();
    } else if (npcMood === "happy"){
      ctx.beginPath(); ctx.moveTo(112, 54); ctx.lineTo(122, 56); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(148, 54); ctx.lineTo(138, 56); ctx.stroke();
    }

    // mouth
    ctx.beginPath();
    ctx.strokeStyle = "rgba(0,0,0,0.75)";
    ctx.lineWidth = 2.4;
    if (npcMood === "happy"){
      ctx.arc(130, 74, 12, 0.10*Math.PI, 0.90*Math.PI);
    } else if (npcMood === "sad"){
      ctx.arc(130, 85, 12, 1.10*Math.PI, 1.90*Math.PI);
    } else {
      ctx.arc(130, 78, 10, 0.15*Math.PI, 0.85*Math.PI);
    }
    ctx.stroke();

    // torso
    ctx.fillStyle = shirt;
    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(112, 104, 36, 110, 8);
    ctx.fill();
    ctx.stroke();

    // arms
    ctx.lineWidth = 4;
    ctx.strokeStyle = "rgba(255,255,255,0.80)";
    ctx.beginPath();
    ctx.moveTo(112, 132); ctx.lineTo(70, 165);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(148, 132); ctx.lineTo(190, 165);
    ctx.stroke();

    // legs
    ctx.beginPath();
    ctx.moveTo(124, 214); ctx.lineTo(124, 315);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(136, 214); ctx.lineTo(136, 315);
    ctx.stroke();

    // SIGN (left side)
    const signX = 14, signY = 128, signW = 56, signH = 130;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.fillStyle = submitEnabled ? "rgba(251,191,36,0.95)" : "rgba(255,255,255,0.12)";
    ctx.beginPath();
    ctx.roundRect(signX, signY, signW, signH, 10);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = submitEnabled ? "rgba(0,0,0,0.85)" : "rgba(255,255,255,0.82)";
    ctx.font = "900 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const lines = submitEnabled
      ? ["CLICK","TO","SUBMIT"]
      : ["SELECT","AN","ANSWER","FIRST"];

    const centerX = signX + signW / 2;
    const centerY = signY + signH / 2;
    const lineGap = 18;
    const startY = centerY - ((lines.length - 1) * lineGap) / 2;

    lines.forEach((t, i) => ctx.fillText(t, centerX, startY + i * lineGap));

    npcCanvas.style.cursor = submitEnabled ? "pointer" : "default";
  }

  // -----------------------------
  // UI RENDER
  // -----------------------------
  function renderStart() {
    selectedOption = null;
    submitEnabled = false;
    npcMood = "neutral";
    updateStabilityPill();
    drawNPC();

    const hasSave = !!localStorage.getItem(STORAGE_KEY);

    leftPanel.innerHTML = `
      <div class="start">
        <h2>Mission Brief: Why the 1960s‚Äì1970s?</h2>
        <p class="copy">
          The 1960s and 1970s were a turning point in modern history:
          music and youth culture exploded (Beatles, Woodstock), and technology leaped forward
          (spaceflight, the Moon landing, ARPANET, microprocessors). This game uses those real milestones
          as checkpoints ‚Äî each correct answer ‚Äústabilizes‚Äù your time travel.
        </p>

        <div class="callout">
          <strong>Gameplay upgrade:</strong> Instead of restarting after three wrong answers,
          you have <strong>Time Stability</strong> (3). When it hits 0, you go to a <strong>Recovery</strong>
          screen with your stats and continue from the same place (no full reset).
        </div>

        <div class="btnRow">
          <button class="btn" id="startBtn">Start New Run</button>
          ${hasSave ? `<button class="btn secondary" id="continueBtn">Continue Saved Run</button>` : ``}
          ${hasSave ? `<button class="btn secondary" id="resetBtn">Reset Saved Progress</button>` : ``}
        </div>

        <div class="hint" style="margin-top:14px;">
          Pro tip: Tap an option, then click the NPC sign or press <span class="kbd">Enter</span>.
          Correct answers play a happy sound + confetti üéâ
        </div>
      </div>
    `;

    document.getElementById("startBtn").addEventListener("click", () => {
      resetRun();
      renderQuestion();
    });

    if (hasSave){
      document.getElementById("continueBtn").addEventListener("click", () => {
        loadState();
        // If stability is 0, take them to recovery
        if (stability <= 0) renderRecovery();
        else renderQuestion();
      });
      document.getElementById("resetBtn").addEventListener("click", () => {
        clearSave();
        showToast("Progress reset", "Saved progress cleared. Start a new run.");
        renderStart();
      });
    }
  }

  function renderQuestion() {
    const q = QUESTIONS[qnum];
    selectedOption = null;
    submitEnabled = false;
    npcMood = "neutral";
    updateStabilityPill();
    drawNPC();

    const level = levelForQuestion(qnum);
    const shuffled = shuffle(q.options);

    const progressPct = Math.round(((qnum - 1) / TOTAL_QUESTIONS) * 100);
    const totalAnswered = correctCount + wrongCount;

    leftPanel.innerHTML = `
      <div class="statusGrid">
        <div class="stat">
          <div class="k">Question</div>
          <div class="v">${qnum} / ${TOTAL_QUESTIONS}</div>
        </div>
        <div class="stat">
          <div class="k">Year</div>
          <div class="v">${q.year}</div>
        </div>
        <div class="stat">
          <div class="k">Level</div>
          <div class="v">${level}</div>
        </div>
        <div class="stat">
          <div class="k">Score</div>
          <div class="v">${score}</div>
        </div>
        <div class="stat">
          <div class="k">Accuracy</div>
          <div class="v">${accuracy()}%</div>
        </div>
      </div>

      <div class="progressWrap">
        <div class="progressLabel">
          <div><b>Progress</b> ‚Äî answered ${totalAnswered} so far</div>
          <div>${progressPct}%</div>
        </div>
        <div class="bar"><div id="progressBar"></div></div>
      </div>

      <div class="qline">
        <h3>Time Travel Checkpoint</h3>
        <div class="pill">Streak: <b style="color:var(--text)">${streak}</b> ‚Ä¢ Best: <b style="color:var(--text)">${bestStreak}</b></div>
      </div>

      <div class="question">${q.question}</div>

      <div class="options" id="options"></div>

      <div class="submitRow">
        <button class="btn" id="submitBtn" disabled style="opacity:0.55; cursor:not-allowed;">Submit</button>
        <span class="kbd">Enter</span>
        <span class="hint" style="margin:0;">You can also click the NPC sign to submit.</span>
      </div>

      <div class="hint">
        <b>Clear instructions:</b> Pick an option ‚Üí then submit. Correct = +${POINTS_PER_CORRECT} points + confetti + happy sound.
        Wrong = stability drops (no full restart).
      </div>
    `;

    document.getElementById("progressBar").style.width = `${progressPct}%`;

    const optionsDiv = document.getElementById("options");
    const submitBtn = document.getElementById("submitBtn");

    shuffled.forEach(opt => {
      const btn = document.createElement("div");
      btn.className = "opt";
      btn.textContent = opt;
      btn.addEventListener("click", () => {
        selectedOption = opt;
        [...optionsDiv.children].forEach(c => c.classList.remove("selected"));
        btn.classList.add("selected");
        submitEnabled = true;
        submitBtn.disabled = false;
        submitBtn.style.opacity = "1";
        submitBtn.style.cursor = "pointer";
        drawNPC();
      });
      optionsDiv.appendChild(btn);
    });

    submitBtn.addEventListener("click", () => submitAnswer());

    saveState();
  }

  function renderRecovery() {
    selectedOption = null;
    submitEnabled = false;
    npcMood = "sad";
    updateStabilityPill();
    drawNPC();

    const total = correctCount + wrongCount;
    const missedList = Object.keys(misses).map(k => Number(k)).sort((a,b)=>a-b);

    leftPanel.innerHTML = `
      <div class="start">
        <h2>Recovery Mode (No Restart)</h2>
        <p class="copy">
          Your <b>Time Stability</b> hit 0 ‚Äî but you don‚Äôt lose your progress.
          Review what happened, then continue from <b>Question ${qnum}</b>.
        </p>

        <div class="callout">
          <strong>Progress tracking:</strong><br>
          ‚Ä¢ Correct: <b>${correctCount}</b> ‚Ä¢ Wrong: <b>${wrongCount}</b> ‚Ä¢ Accuracy: <b>${accuracy()}%</b><br>
          ‚Ä¢ Best streak: <b>${bestStreak}</b><br>
          ‚Ä¢ Current score: <b>${score}</b>
        </div>

        <div class="callout">
          <strong>Penalty to keep it fair:</strong> Continuing costs <b>${RECOVERY_PENALTY}</b> points
          (score will not go below 0). Time Stability resets back to ${MAX_STABILITY}.
        </div>

        ${missedList.length ? `
          <div class="callout">
            <strong>Missed so far:</strong><br>
            ${missedList.slice(0,6).map(n=>{
              const m = misses[n];
              const q = QUESTIONS[n];
              return `‚Ä¢ Q${n} (${q.year}): you picked ‚Äú${escapeHtml(m.picked)}‚Äù ‚Äî correct was ‚Äú${escapeHtml(m.answer)}‚Äù`;
            }).join("<br>")}
            ${missedList.length>6 ? `<br>‚Ä¶and ${missedList.length-6} more` : ``}
          </div>
        ` : `
          <div class="callout"><strong>Nice:</strong> No missed questions recorded yet.</div>
        `}

        <div class="btnRow">
          <button class="btn" id="continueAfterRecovery">Continue</button>
          <button class="btn secondary" id="goHome">Main Menu</button>
        </div>

        <div class="hint" style="margin-top:14px;">
          Tip: On the next correct answer you‚Äôll see confetti + a happy sound again.
        </div>
      </div>
    `;

    document.getElementById("continueAfterRecovery").addEventListener("click", () => {
      score = Math.max(0, score - RECOVERY_PENALTY);
      stability = MAX_STABILITY;
      npcMood = "neutral";
      updateStabilityPill();
      saveState();
      renderQuestion();
    });

    document.getElementById("goHome").addEventListener("click", renderStart);

    saveState();
  }

  function renderEnd(title, extra) {
    selectedOption = null;
    submitEnabled = false;
    npcMood = "happy";
    updateStabilityPill();
    drawNPC();

    const missedList = Object.keys(misses).map(k => Number(k)).sort((a,b)=>a-b);

    leftPanel.innerHTML = `
      <div class="start">
        <h2>${title}</h2>
        <p class="copy">${extra}</p>

        <div class="callout">
          <strong>Final stats</strong><br>
          Score: <b>${score}</b><br>
          Correct: <b>${correctCount}</b> ‚Ä¢ Wrong: <b>${wrongCount}</b> ‚Ä¢ Accuracy: <b>${accuracy()}%</b><br>
          Best streak: <b>${bestStreak}</b>
        </div>

        ${missedList.length ? `
          <div class="callout">
            <strong>Review missed questions</strong><br>
            ${missedList.map(n=>{
              const m = misses[n];
              const q = QUESTIONS[n];
              return `‚Ä¢ Q${n} (${q.year}): picked ‚Äú${escapeHtml(m.picked)}‚Äù ‚Äî correct: ‚Äú${escapeHtml(m.answer)}‚Äù`;
            }).join("<br>")}
          </div>
        ` : `
          <div class="callout"><strong>Perfect run!</strong> You didn‚Äôt miss any questions.</div>
        `}

        <div class="btnRow">
          <button class="btn" id="playAgain">Play Again</button>
          <button class="btn secondary" id="clearSaved">Clear Saved Progress</button>
        </div>

        <div class="hint" style="margin-top:14px;">
          This game is tied to the 1960s‚Äì1970s because each checkpoint is based on real events and tech breakthroughs from that era.
        </div>
      </div>
    `;

    document.getElementById("playAgain").addEventListener("click", () => {
      resetRun();
      renderQuestion();
    });

    document.getElementById("clearSaved").addEventListener("click", () => {
      clearSave();
      showToast("Cleared", "Saved progress removed.");
      renderStart();
    });

    saveState();
  }

  function resetRun(){
    qnum = 1;
    score = 0;
    stability = MAX_STABILITY;
    correctCount = 0;
    wrongCount = 0;
    streak = 0;
    bestStreak = 0;
    misses = {};
    saveState();
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // -----------------------------
  // GAME LOGIC
  // -----------------------------
  function submitAnswer() {
    if (!submitEnabled || !selectedOption) {
      showToast("Select an answer first", "Then submit using the button or NPC sign.");
      return;
    }

    const q = QUESTIONS[qnum];

    if (selectedOption === q.answer) {
      score += POINTS_PER_CORRECT;
      correctCount += 1;
      streak += 1;
      bestStreak = Math.max(bestStreak, streak);

      npcMood = "happy";
      drawNPC();

      // effects
      playHappySound();
      spawnConfetti();

      showToast("Correct! üéâ", `${q.fact}\n\n+${POINTS_PER_CORRECT} points`);

    } else {
      wrongCount += 1;
      streak = 0;
      stability -= 1;

      misses[qnum] = { picked: selectedOption, answer: q.answer };

      npcMood = "sad";
      updateStabilityPill();
      drawNPC();

      playSadSound();

      showToast("Wrong üòü", `Correct answer: ${q.answer}\nTime Stability: ${stabilityDots()}`);
    }

    // Persist progress
    saveState();

    // Recovery instead of restart
    if (stability <= 0) {
      renderRecovery();
      return;
    }

    // Move on
    if (qnum < TOTAL_QUESTIONS) {
      qnum += 1;
      renderQuestion();
    } else {
      // finished: optionally keep save, but they can clear
      renderEnd("Time Travel Complete!", "Nice job finishing all 20 questions!");
    }
  }

  // Click anywhere on NPC canvas submits if enabled
  npcCanvas.addEventListener("click", () => {
    if (submitEnabled) submitAnswer();
    else showToast("Not ready yet", "Pick an answer first.");
  });

  // Keyboard accessibility: Enter submits
  window.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      if (submitEnabled) submitAnswer();
    }
  });

  // -----------------------------
  // INIT
  // -----------------------------
  updateStabilityPill();
  drawNPC();

  // If there is a saved game, show start screen with Continue option.
  // If no save, show start screen.
  renderStart();
</script>
</body>
</html>
